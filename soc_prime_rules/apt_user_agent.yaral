rule apt_user_agent {
 meta:
    author = "Florian Roth"
    description = "Detects suspicious user agent strings used in APT malware in proxy logs  License: https://github.com/Neo23x0/sigma/blob/master/LICENSE.Detection.Rules.md."
    reference = "https://tdm.socprime.com/tdm/info/MVLHCM0mCHxW"
    version = "0.01"
    created = "2021-03-09"
    category = "proxy"

  events:
($selection.src.application = "SJZJ (compatible; MSIE 6.0; Win32)" or $selection.src.application = "Mozilla/5.0 (Windows NT 6.; WOW64; rv:20.0) Gecko/20100101 Firefox/20.0" or $selection.src.application = "User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; SLCC" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 7.4; Win32;32-bit)" or $selection.src.application = "webclient" or $selection.src.application = "Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-EN; rv:1.7.12) Gecko/200" or $selection.src.application = "Mozilla/4.0 (compatible; MSI 6.0;" or $selection.src.application = "Mozilla/5.0 (Windows NT 6.3; WOW64; rv:28.0) Gecko/20100101 Firefox/28.0" or $selection.src.application = "Mozilla/5.0 (Windows NT 6.2; WOW64; rv:20.0) Gecko/20100101 Firefox" or $selection.src.application = "Mozilla/5.0 (Windows NT 6.; WOW64; rv:20.0) Gecko/20100101 Firefox/2" or $selection.src.application = "Mozilla/4.0" or $selection.src.application = "Netscape" or $selection.src.application = "Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-EN; rv:1.7.12) Gecko/20100719 Firefox/1.0.7" or $selection.src.application = "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.2.13) Firefox/3.6.13 GTB7.1" or $selection.src.application = "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NETCLR 2.0.50727)" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; SV1)" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 11.0; Windows NT 6.1; SV1)" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 8.0; Win32)" or $selection.src.application = "Mozilla v5.1 (Windows NT 6.1; rv:6.0.1) Gecko/20100101 Firefox/6.0.1" or $selection.src.application = "Mozilla/6.1 (compatible; MSIE 9.0; Windows NT 5.3; Trident/5.0)" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727; .NET CLR 3.0.04506.30; .NET CLR 3.0.04506.648; InfoPath.1)" or $selection.src.application = "Mozilla/5.0 (Windows NT 6.1; WOW64) WinHttp/1.6.3.8 (WinHTTP/5.1) like Gecko" or re.regex($selection.src.application, `Mozilla v5\.1 .*`) or $selection.src.application = "MSIE 8.0" or $selection.src.application = "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; InfoPath.2)")

  condition:
    $selection
}
